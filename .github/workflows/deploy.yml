name: Deploy

on:
  push:
    branches:
      - main

jobs:
  lint_test:
    name: Lint & Test
    uses: ./.github/workflows/lint_test.yml
    secrets: inherit
  code_coverage:
    name: Code coverage
    uses: ./.github/workflows/code_coverage.yml
    needs: [lint_test]
    secrets: inherit
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [lint_test, code_coverage]
    timeout-minutes: 10
    steps:
      - name: Configure SSH
        env:
          SSH_HOST: ${{ secrets.VPS_IP }}
          SSH_USER: ${{ secrets.VPS_USER }}
          SSH_KEY: ${{ secrets.VPS_KEY }}
        run: |
            mkdir -p ~/.ssh/
            echo "$SSH_KEY" > ~/.ssh/deploy.key
            chmod 600 ~/.ssh/deploy.key
            cat >>~/.ssh/config <<END
            Host deploy
              HostName $SSH_HOST
              User $SSH_USER
              IdentityFile ~/.ssh/deploy.key
              StrictHostKeyChecking no
            END
      - name: Stop app
        env: 
          PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          ssh deploy
          echo $PASSWORD | sudo -S systemctl stop gunicorn.socket
      - name: Pull repo and apply migrations
        env: 
          PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          ssh deploy
          cd $PATH
          git pull
          make install
          make migrate
          make collectstatic
      - name: Start app
        if: ${{ always() }}
        env: 
          PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          ssh deploy
          echo $PASSWORD | sudo -S systemctl start gunicorn.socket
